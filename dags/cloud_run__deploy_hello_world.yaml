group: cloud_run
tags: cloud_run,step_1
env:
  - DAG_NAME: cloud_run__deploy_hello_world
  - GCP_PROJECT: ${GOOGLE_CLOUD_PROJECT}
  - DAG_WORK_DIR: ${DAGU_WORK_DIR}/${DAG_NAME}
  - GIT_REPO: https://github.com/GoogleCloudPlatform/python-docs-samples.git
  - GIT_REPO_DIR: ${DAG_WORK_DIR}/python-docs-samples/run/helloworld
  - CONTAINER_IMAGE: gcr.io/${GCP_PROJECT}/helloworld
params: GCP_PROJECT=<gcp_project> RUN_REGION=us-central1 RUN_SERVICE=hello_world
steps:
  - name: "clean_work_dir"
    command: rm -rf ${DAG_WORK_DIR}
  - name: "create_work_dir"
    command: mkdir -p ${DAG_WORK_DIR}
    depends:
      - clean_work_dir
  - name: "clone_github_repo"
    dir: ${DAG_WORK_DIR}
    command: git clone --depth=1 https://github.com/GoogleCloudPlatform/python-docs-samples.git
    depends:
      - create_work_dir
  - name: "set_gcp_project"
    command: gcloud config set project ${GCP_PROJECT}
  - name: "create_container_image"
    dir: ${GIT_REPO_DIR}
    command: gcloud builds submit --pack image=gcr.io/${GCP_PROJECT}/${RUN_SERVICE} --project=${GCP_PROJECT}
    depends:
      - set_gcp_project
      - clone_github_repo
  - name: "deploy_revision"
    command: gcloud run deploy ${RUN_SERVICE} --image=gcr.io/${GCP_PROJECT}/${RUN_SERVICE} --concurrency=1 --max-instances=1 --region=${RUN_REGION} --project=${GCP_PROJECT}
    depends:
      - set_gcp_project
      - clone_github_repo
      - create_container_image
  - name: "describe_run_service"
    command: gcloud run services describe ${RUN_SERVICE} --region=${RUN_REGION} --project=${GCP_PROJECT} --format=flattened
    depends:
      - set_gcp_project
      - clone_github_repo
      - create_container_image
      - deploy_revision
