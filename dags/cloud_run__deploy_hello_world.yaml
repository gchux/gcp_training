group: cloud_run
tags: cloud_run,step_1
env:
  - _NAMESPACE: cloud_run
  - _TARGET: deploy_hello_world
  - _DAG_NAME: ${_NAMESPACE}__${_TARGET}
  - _DAG_WORK_DIR: ${_WORK_DIR}/${_DAG_NAME}
  - _TASK_FILE: ${_TASKS_DIR}/${_NAMESPACE}/${_TARGET}/Taskfile.yaml
  - _TASK_CMD: task -t ${_TASK_FILE} -v
  - _RUN_CMD: ${_DAG_WORK_DIR}/run
  - GCP_PROJECT: ${GOOGLE_CLOUD_PROJECT}
  - GIT_REPO_URL: https://github.com/GoogleCloudPlatform/python-docs-samples.git
  - GIT_REPO_DIR: ${_DAG_WORK_DIR}/python-docs-samples/run/helloworld
params: GCP_PROJECT=<gcp_project> RUN_REGION=us-central1 RUN_SERVICE=helloworld
steps:
  - name: "prepare_work_dir"
    command: bash
    script: |
      rm -rf ${_DAG_WORK_DIR}
      mkdir -p ${_DAG_WORK_DIR}
      echo -e "#!/bin/bash\n${_TASK_CMD} \$1 TASK_DIR=\$2 \$3" > ${_RUN_CMD}
      chmod +x ${_RUN_CMD}
  - name: "clone_git_repo"
    dir: ${_DAG_WORK_DIR}
    command: ./run clone_git_repo ${_DAG_WORK_DIR} "GIT_REPO_URL=${GIT_REPO_URL}"
    depends:
      - prepare_work_dir
  - name: "set_gcp_project"
    dir: ${_DAG_WORK_DIR}
    command: ./run set_gcp_project ${_DAG_WORK_DIR} "GCP_PROJECT=${GCP_PROJECT}"
    depends:
      - prepare_work_dir
  - name: "create_container_image"
    dir: ${_DAG_WORK_DIR}
    command: ./run create_container_image ${GIT_REPO_DIR} "GCP_PROJECT=${GCP_PROJECT} RUN_SERVICE=${RUN_SERVICE}"
    depends:
      - clone_git_repo
      - set_gcp_project
  - name: "deploy_run_revision"
    dir: ${_DAG_WORK_DIR}
    command: ./run deploy_run_revision ${_DAG_WORK_DIR} "GCP_PROJECT=${GCP_PROJECT} RUN_SERVICE=${RUN_SERVICE} RUN_REGION=${RUN_REGION}"
    depends:
      - create_container_image
  - name: "describe_run_service"
    dir: ${_DAG_WORK_DIR}
    command: ./run describe_run_revision ${_DAG_WORK_DIR} "GCP_PROJECT=${GCP_PROJECT} RUN_SERVICE=${RUN_SERVICE} RUN_REGION=${RUN_REGION}"
    depends:
      - deploy_run_revision
